Code seems not so efficient if N (that is M) is taken relatively large.
Why is that happening? 